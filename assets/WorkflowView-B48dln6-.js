import{a as u,b,M as B,e as i,o as l,f as n,v as y,z as S,G as M,F as T,h as D,t as c,g as _,j as L,n as A,c as U,r as I,i as x,E as $}from"./vendor-Crb1Va-d.js";import{_ as w,u as h}from"./index-CLG5q7cM.js";const j=u([{id:1,name:"申请人",role:"applicant"},{id:2,name:"审批人",role:"approver"}]),N=u([{id:1,name:"物料A",spec:"型号1",unit:"个"},{id:2,name:"物料B",spec:"型号2",unit:"kg"}]),P=u([]),g=u([]),C=u(null),v={getMaterials(){return Promise.resolve(N.value)},submitApplication(o){const e={id:Date.now(),...o,status:"pending",createBy:o.userId,createTime:new Date().toISOString()};P.value.push(e),console.log({data:o});const r={id:Date.now(),appId:e.id,type:"approval",assignee:o.approvalRole,status:"pending",remark:o.remark,createBy:o.userId,createTime:new Date().toISOString()};return g.value.push(r),Promise.resolve(r)},getMyTasks(o){return console.log(o,"getlist: ",g.value),Promise.resolve(g.value.filter(e=>e.assignee===o))},getTaskDetail(o){var t;const e=g.value.find(a=>a.id==o);if(!e)return Promise.reject("Task not found");const r=P.value.find(a=>a.id==e.appId);return Promise.resolve({...e,app:r,applicant:((t=j.value.find(a=>a.id===r.userId))==null?void 0:t.name)||"Unknown"})},processTask(o,e){const r=g.value.find(a=>a.id==o);if(!r)return Promise.reject("Task not found");r.status=e;const t=P.value.find(a=>a.id==r.appId);if(t&&(t.status=e),e==="approved"){const a={id:Date.now(),appId:t.id,type:"complete",assignee:1,status:"pending",createTime:new Date().toISOString()};g.value.push(a)}return Promise.resolve(!0)},getProcessDefinition(){return Promise.resolve(C.value)},saveProcessDefinition(o){return C.value={xml:o},Promise.resolve(!0)}},F={props:["xml"],setup(o,{emit:e}){const r=u(null),t=u(null);let a=null;return b(()=>{a=new B({container:r.value,propertiesPanel:{parent:t.value}}),(o.xml?a.importXML(o.xml):a.createDiagram()).then(()=>{a.on("commandStack.changed",async()=>{const{xml:s}=await a.saveXML({format:!0});e("update:xml",s)})})}),{container:r,properties:t}}},X={class:"process-designer"},q={ref:"container",class:"bpmn-container"},R={ref:"properties",class:"properties-panel"};function E(o,e,r,t,a,p){return l(),i("div",X,[n("div",q,null,512),n("div",R,null,512)])}const O=w(F,[["render",E],["__scopeId","data-v-47a5ea46"]]),z={emits:["submitted"],setup(o,{emit:e}){const r=h(),t=u(["guest","operator","admin","superAdmin"]),a=u([]),p=u({materialId:null,quantity:1,remark:"",userId:r.crole,approvalRole:"admin"});return b(async()=>{var d;a.value=await v.getMaterials(),p.value.materialId=((d=a.value[0])==null?void 0:d.id)||null}),{materials:a,form:p,roleList:t,submit:async()=>{console.log("submittt: ",p.value);const d=await v.submitApplication(p.value);e("submitted",d.id)}}}},G={class:"application-form"},W={class:"form-item"},H={class:"form-item"},J=["value"],K={class:"form-item"},Q=["value"],Y={class:"form-item"},Z={class:"form-item"};function ee(o,e,r,t,a,p){return l(),i("div",G,[e[11]||(e[11]=n("h3",null,"物料申请",-1)),n("div",W,[e[6]||(e[6]=n("label",null,"申请人：",-1)),y(n("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>t.form.userId=s),disabled:""},null,512),[[S,t.form.userId]])]),n("div",H,[e[7]||(e[7]=n("label",null,"审批人：",-1)),y(n("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>t.form.approvalRole=s)},[(l(!0),i(T,null,D(t.roleList,s=>(l(),i("option",{key:s,value:s},c(s),9,J))),128))],512),[[M,t.form.approvalRole]])]),n("div",K,[e[8]||(e[8]=n("label",null,"物料：",-1)),y(n("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>t.form.materialId=s)},[(l(!0),i(T,null,D(t.materials,s=>(l(),i("option",{key:s.id,value:s.id},c(s.name)+" ("+c(s.spec)+") - "+c(s.unit),9,Q))),128))],512),[[M,t.form.materialId]])]),n("div",Y,[e[9]||(e[9]=n("label",null,"数量：",-1)),y(n("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=s=>t.form.quantity=s),min:"1"},null,512),[[S,t.form.quantity,void 0,{number:!0}]])]),n("div",Z,[e[10]||(e[10]=n("label",null,"说明：",-1)),y(n("textarea",{"onUpdate:modelValue":e[4]||(e[4]=s=>t.form.remark=s),rows:"3"},null,512),[[S,t.form.remark]])]),n("button",{onClick:e[5]||(e[5]=(...s)=>t.submit&&t.submit(...s))},"提交申请")])}const te=w(z,[["render",ee],["__scopeId","data-v-4baab8d9"]]),se={props:["taskId"],emits:["back"],setup(o){const e=u(null),r=u([]);return b(async()=>{r.value=await v.getMaterials(),e.value=await v.getTaskDetail(o.taskId)}),{task:e,approve:async s=>{await v.processTask(o.taskId,s),e.value=await v.getTaskDetail(o.taskId)},getMaterialName:s=>{const d=r.value.find(f=>f.id===s);return d?`${d.name} (${d.spec})`:"未知物料"},getStatusText:s=>({pending:"待审批",approved:"已同意",rejected:"已拒绝"})[s]||s}}},ne={class:"approval-task"},oe={key:0},ae={class:"task-info"},re={key:0,class:"action-buttons"},le={key:1,class:"result-message"},ie={key:1};function de(o,e,r,t,a,p){return l(),i("div",ne,[e[4]||(e[4]=n("h3",null,"审批任务",-1)),t.task?(l(),i("div",oe,[n("div",ae,[n("p",null,"申请人："+c(t.task.applicant),1),n("p",null,"物料："+c(t.getMaterialName(t.task.app.materialId)),1),n("p",null,"数量："+c(t.task.app.quantity),1),n("p",null,"说明："+c(t.task.app.remark),1),n("p",null,"状态："+c(t.getStatusText(t.task.status)),1)]),t.task.status==="pending"?(l(),i("div",re,[n("button",{onClick:e[0]||(e[0]=s=>t.approve("approved"))},"同意"),n("button",{onClick:e[1]||(e[1]=s=>t.approve("rejected"))},"拒绝")])):(l(),i("div",le,[n("p",null,"已"+c(t.task.status==="approved"?"同意":"拒绝")+"该申请",1),n("button",{onClick:e[2]||(e[2]=s=>o.$emit("back"))},"返回")]))])):(l(),i("div",ie,e[3]||(e[3]=[n("p",null,"加载中...",-1)])))])}const ce=w(se,[["render",de],["__scopeId","data-v-4de4370d"]]),ue={props:["userId"],emits:["task-selected"],setup(o,{emit:e}){const r=u([]);return b(async()=>{console.log("tasklist: ",o.userId),r.value=await v.getMyTasks(o.userId)}),{tasks:r,handleTask:d=>{e("task-selected",d)},getStatusText:d=>({pending:"待处理",approved:"已同意",rejected:"已拒绝"})[d]||d,getStatusColor:d=>({pending:"blue",approved:"green",rejected:"red"})[d]||d,formatDate:d=>new Date(d).toLocaleString()}}},pe={class:"task-list"},me={key:0},ve={class:"approval_p"},ke=["onClick"],fe={key:1};function ge(o,e,r,t,a,p){return l(),i("div",pe,[e[2]||(e[2]=n("h3",null,"我的任务",-1)),t.tasks.length?(l(),i("div",me,[(l(!0),i(T,null,D(t.tasks,s=>(l(),i("div",{key:s.id,class:"task-item"},[n("p",null,"申请ID: "+c(s.appId),1),n("p",null,"申请人: "+c(s.createBy),1),n("p",null,"描述: "+c(s.remark),1),n("p",ve,"审批人: "+c(s.assignee),1),n("p",null,"类型: "+c(s.type==="approval"?"审批":"处理"),1),n("p",null,[e[0]||(e[0]=L("状态: ")),n("span",{class:A(["status_txt",t.getStatusColor(s.status)])},c(t.getStatusText(s.status)),3)]),n("p",null,"创建时间: "+c(t.formatDate(s.createTime)),1),s.status==="pending"?(l(),i("button",{key:0,onClick:d=>t.handleTask(s.id)}," 处理 ",8,ke)):_("",!0)]))),128))])):(l(),i("div",fe,e[1]||(e[1]=[n("p",null,"暂无任务",-1)])))])}const _e=w(ue,[["render",ge],["__scopeId","data-v-5473bb6b"]]),ye={components:{ProcessDesigner:O,ApplicationForm:te,ApprovalTask:ce,TaskList:_e},setup(){const o=h(),e=[{id:"design",label:"流程设计"},{id:"apply",label:"提交申请"},{id:"tasks",label:"我的任务"}],r=u("apply"),t=u(null),a=u(o.crole),p=u(null),s=u(!1);return b(async()=>{o.crole||$({type:"info",message:"未登录! 请先登录再操作",duration:3e3});const k=await v.getProcessDefinition();k!=null&&k.xml&&(p.value=k.xml,s.value=!0)}),{views:e,currentView:r,currentTaskId:t,currentUserId:a,processXml:p,showDesigner:s,handleSubmitted:k=>{t.value=k,r.value="tasks"},handleTaskSelected:k=>{t.value=k,r.value="approval"},saveProcess:async()=>{await v.saveProcessDefinition(p.value),alert("流程保存成功")},deployProcess:async()=>{await v.saveProcessDefinition(p.value),alert("流程部署成功")}}}},be={class:"workflow-view"},we={class:"view-switcher"},Ie=["onClick"],Te={class:"view-content"},De={key:0,class:"design-view"},Se={class:"actions"},xe={key:1},Pe={key:2},Ve={key:3};function Me(o,e,r,t,a,p){const s=I("ProcessDesigner"),d=I("ApplicationForm"),f=I("TaskList"),V=I("ApprovalTask");return l(),i("div",be,[n("div",we,[(l(!0),i(T,null,D(t.views,m=>(l(),i("button",{key:m.id,onClick:k=>t.currentView=m.id,class:A({active:t.currentView===m.id})},c(m.label),11,Ie))),128))]),n("div",Te,[t.currentView==="design"?(l(),i("div",De,[t.showDesigner?(l(),U(s,{key:0,xml:t.processXml,"onUpdate:xml":e[0]||(e[0]=m=>t.processXml=m)},null,8,["xml"])):_("",!0),n("div",Se,[n("button",{onClick:e[1]||(e[1]=(...m)=>t.saveProcess&&t.saveProcess(...m))},"保存流程"),n("button",{onClick:e[2]||(e[2]=(...m)=>t.deployProcess&&t.deployProcess(...m))},"部署流程")])])):_("",!0),t.currentView==="apply"?(l(),i("div",xe,[x(d,{onSubmitted:t.handleSubmitted},null,8,["onSubmitted"])])):_("",!0),t.currentView==="tasks"?(l(),i("div",Pe,[x(f,{userId:t.currentUserId,onTaskSelected:t.handleTaskSelected},null,8,["userId","onTaskSelected"])])):_("",!0),t.currentView==="approval"?(l(),i("div",Ve,[x(V,{taskId:t.currentTaskId,onBack:e[3]||(e[3]=m=>t.currentView="tasks")},null,8,["taskId"])])):_("",!0)])])}const he=w(ye,[["render",Me],["__scopeId","data-v-f51b76e8"]]);export{he as default};
